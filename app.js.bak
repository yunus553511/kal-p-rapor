// Modern animasyonlu uygulama ana JS dosyası
// Google Sheets'ten özet verileri çek, kutulara animasyonlu yaz, arama ve popup için temel fonksiyonlar

// SheetJS proxy ile Google Sheets'ten veri çekme ve kutulara animasyonlu yazma
const SHEET_OZET_XLSX = 'https://docs.google.com/spreadsheets/d/1RP5kRFKAUUJye7-lPnlmeNaN805eF_88/export?format=xlsx&id=1RP5kRFKAUUJye7-lPnlmeNaN805eF_88&gid=2132791514';
const SHEET_DETAY_XLSX = 'https://docs.google.com/spreadsheets/d/1RP5kRFKAUUJye7-lPnlmeNaN805eF_88/export?format=xlsx&id=1RP5kRFKAUUJye7-lPnlmeNaN805eF_88&gid=600580160';

let proxyReady = false;
function waitProxyReady(cb) {
    if (proxyReady) { cb(); return; }
    function onReady(e) {
        if (e.data && e.data.source === 'proxy' && e.data.action === 'ready') {
            window.removeEventListener('message', onReady);
            proxyReady = true;
            cb();
        }
    }
    window.addEventListener('message', onReady);
}

function requestSheetFromProxy(url, gid, cb) {
    const proxy = document.getElementById('proxyFrame').contentWindow;
    function onMessage(e) {
        if (!e.data || e.data.source !== 'proxy') return;
        if (e.data.action === 'sheetLoaded' && e.data.gid === gid) {
            window.removeEventListener('message', onMessage);
            cb(e.data.buffer);
        }
        if (e.data.action === 'error') {
            window.removeEventListener('message', onMessage);
            alert('Veri yükleme hatası: ' + e.data.error);
        }
    }
    window.addEventListener('message', onMessage);
    proxy.postMessage({ action: 'loadSheet', url, gid }, '*');
}

function fetchAndAnimateStats() {
    showLoading(true);
    requestSheetFromProxy(SHEET_OZET_XLSX, '2132791514', function(buffer) {
        const workbook = XLSX.read(buffer, { type: 'array' });
        const ws = workbook.Sheets[workbook.SheetNames[0]];
        const B2 = ws['B2'] ? ws['B2'].v : 0;
        const C2 = ws['C2'] ? ws['C2'].v : 0;
        const D2 = ws['D2'] ? ws['D2'].v : 0;
        animateValue('farkliProfilAdeti', 0, Number(B2), 1000);
        animateValue('aktifKalipAdeti', 0, Number(C2), 1000);
        animateValue('hurdaKalipAdeti', 0, Number(D2), 1000);
        // --- Güncelleme bildirimi için hash kontrolü ---
        const ozetString = JSON.stringify([B2, C2, D2]);
        const hash = btoa(unescape(encodeURIComponent(ozetString)));
        if (lastOzetHash !== null && lastOzetHash !== hash) {
            showUpdateNotification();
        }
        lastOzetHash = hash;
        showLoading(false);
    });
}
function animateValue(id, start, end, duration) {
    const obj = document.getElementById(id);
    let startTimestamp = null;
    const step = timestamp => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) window.requestAnimationFrame(step);
        else obj.textContent = end;
    };
    window.requestAnimationFrame(step);
}
// Logo animasyonu ve başlık harf animasyonu
function initLogoAnim() {
    const logo = document.getElementById('logo');
    if (!logo) return;
    logo.style.opacity = '0';
    logo.style.transform = 'scale(0.8)';
    setTimeout(() => {
        logo.style.transition = 'all 0.8s cubic-bezier(.4,2,.6,1)';
        logo.style.opacity = '1';
        logo.style.transform = 'scale(1)';
    }, 300);
}
function initTitleAnim() {
    const title = document.querySelector('.gradient-text');
    if (!title) return;
    const text = title.textContent;
    let html = '';
    for (let i = 0; i < text.length; i++) {
        if (text[i] === ' ') html += ' ';
        else html += `<span style="display:inline-block;opacity:0;animation:fadeInUp 0.8s ${(i*0.06)+0.4}s forwards;">${text[i]}</span>`;
    }
    title.innerHTML = html;
}

function searchProfileCode(kod) {
    if (!kod || kod.trim() === '') {
        showResults([]);
        return;
    }
    showLoading(true);
    requestSheetFromProxy(SHEET_DETAY_XLSX, '600580160', function(buffer) {
        const workbook = XLSX.read(buffer, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const range = XLSX.utils.decode_range(sheet['!ref']);
        let results = [];
        let allRows = [];
        for (let row = range.s.r + 1; row <= range.e.r; row++) { // +1: başlık atla
            let rowData = {};
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cell = sheet[XLSX.utils.encode_cell({c:col, r:row})];
                const headerCell = sheet[XLSX.utils.encode_cell({c:col, r:range.s.r})];
                const key = headerCell ? String(headerCell.v).trim() : XLSX.utils.encode_col(col);
                rowData[key] = cell ? cell.v : '';
            }
            allRows.push(rowData);
            // Eşleşme: başlık 'PROFİL KODU' ile, trim ve küçük harf duyarsız
            if (rowData['PROFİL KODU'] && String(rowData['PROFİL KODU']).trim().toLowerCase() === kod.trim().toLowerCase()) {
                results.push(rowData);
            }
        }
        console.log('Sheetten okunan tüm satırlar:', allRows);
        showResults(results);
        setTimeout(()=>showLoading(false), 1000);
    });
}

// --- POPUP YARDIMCI FONKSİYONLARI ---
function groupByFigurAndFirma(detaySatirlar) {
    // ['1 FİGÜR ALMEKS', ...] -> { '1 FİGÜR ALMEKS': 3, ... }
    const counts = {};
    detaySatirlar.forEach(satir => {
        counts[satir] = (counts[satir] || 0) + 1;
    });
    // '1 FİGÜR ALMEKS' -> { figur: '1 FİGÜR', firma: 'ALMEKS', count: 3 }
    return Object.entries(counts).map(([key, count]) => {
        const parts = key.split(' ');
        return {
            figur: parts.slice(0,2).join(' '),
            firma: parts.slice(2).join(' '),
            count
        };
    });
}

function excelDateToString(excelDate) {
    // Excel seri tarihi -> yyyy-mm-dd
    if (!excelDate) return '';
    if (typeof excelDate === 'string') {
        // ISO format veya DD.MM.YYYY ise dönüştür
        if (/^\d{4}-\d{2}-\d{2}$/.test(excelDate)) return excelDate;
        if (/^\d{2}\.\d{2}\.\d{4}$/.test(excelDate)) {
            const [d, m, y] = excelDate.split('.');
            return `${y}-${m}-${d}`;
        }
    }
    // Excel serial date (float veya int)
    if (!isNaN(excelDate)) {
        // Bazı Excel dosyalarında tarih UTC+0 olarak gelir, saat farkı için +2 saat eklenir
        const utc_days = Math.floor(Number(excelDate) - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);
        // Türkiye için saat farkı düzeltmesi (UTC+3)
        date_info.setHours(date_info.getHours() + 3);
        return date_info.toISOString().slice(0, 10);
    }
    return excelDate;
}

function formatDateForPopup(excelDate) {
    if (!excelDate) return '';
    let dateObj;
    // Excel serial date ise
    if (typeof excelDate === 'number') {
        dateObj = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
    } else if (typeof excelDate === 'string' && /^\d{4}-\d{2}-\d{2}/.test(excelDate)) {
        dateObj = new Date(excelDate);
    } else {
        return excelDate;
    }
    const gun = String(dateObj.getDate()).padStart(2, '0');
    const ay = String(dateObj.getMonth() + 1).padStart(2, '0');
    const yil = dateObj.getFullYear();
    return `${gun}.${ay}.${yil}`;
}

function fetchSayfa4Son4Tarih(kod, callback) {
    // Sayfa4 gid: 278605159
    requestSheetFromProxy(
        'https://docs.google.com/spreadsheets/d/1RP5kRFKAUUJye7-lPnlmeNaN805eF_88/export?format=xlsx&id=1RP5kRFKAUUJye7-lPnlmeNaN805eF_88&gid=278605159',
        '278605159',
        function(buffer) {
            const workbook = XLSX.read(buffer, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            let rows = [];
            
            // Aranan kodu hem direkt hem AP önekiyle arayabilmek için normalize et
            let rawKod = String(kod).trim().toLowerCase();
            let normalizedKod = rawKod;
            let apVersion = '';
            
            // Gonderilen kod AP ile basliyorsa, bir de AP eklenmis versiyonunu kontrol et
            if (!rawKod.startsWith('ap')) {
                apVersion = 'ap' + rawKod;
            } else {
                // Gonderilen kod AP ile basliyorsa, bir de AP'siz halini kontrol et
                normalizedKod = rawKod.substring(2);
            }
            
            console.log(`Aranıyor - Normal kod: "${normalizedKod}", AP versiyonu: "${apVersion ? apVersion : 'Yok'}"`);
            
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const kodCell = sheet[XLSX.utils.encode_cell({c:1, r:row})];
                
                if (!kodCell || !kodCell.v) continue; // Boş hücreleri atla
                
                // Hücre değerini normalize et
                const cellValue = String(kodCell.v).trim().toLowerCase();
                
                // Hem normal kod, hem AP versiyonu ile kontrol et
                if (cellValue === normalizedKod || (apVersion && cellValue === apVersion)) {
                    rows.push({
                        tarih: sheet[XLSX.utils.encode_cell({c:0, r:row})]?.v || '',
                        siparis_boyu: sheet[XLSX.utils.encode_cell({c:2, r:row})]?.v || '',
                        uretilen_adet: sheet[XLSX.utils.encode_cell({c:4, r:row})]?.v || '',
                        uretilen_kg: sheet[XLSX.utils.encode_cell({c:15, r:row})]?.v || '',
                        pres: sheet[XLSX.utils.encode_cell({c:12, r:row})]?.v || '', // M sütunu
                        firma: sheet[XLSX.utils.encode_cell({c:16, r:row})]?.v || '', // Q sütunu
                        sorun: sheet[XLSX.utils.encode_cell({c:17, r:row})]?.v || '',
                        tashihat: sheet[XLSX.utils.encode_cell({c:18, r:row})]?.v || ''
                    });
                }
            }
            
            // Tarihe göre sırala (en yeni başa)
            rows.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));
            callback(rows.slice(0, 4));
        }
    );
}

function fetchSayfa1Tonaj(kod, callback) {
    // Sayfa1 gid: 1238184358
    requestSheetFromProxy(
        'https://docs.google.com/spreadsheets/d/1RP5kRFKAUUJye7-lPnlmeNaN805eF_88/export?format=xlsx&id=1RP5kRFKAUUJye7-lPnlmeNaN805eF_88&gid=1238184358',
        '1238184358',
        function(buffer) {
            const workbook = XLSX.read(buffer, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            let matched = false;
            console.log(`Aranıyor: Kod="${kod}"`);
            
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                // B sütunu = 1 (kodu arama)
                // J sütunu = 9 (kesin tonaj)
                // K sütunu = 10 (tahmini tonaj)
                // L sütunu = 11 (tahmini tenefer)
                const b_cell = sheet[XLSX.utils.encode_cell({c:1, r:row})];
                
                if (!b_cell) continue; // Boş hücreleri atla
                
                const b_str = String(b_cell.v || '').toLowerCase().trim();
                const kod_str = String(kod).toLowerCase().trim(); 
                
                console.log(`Kontrol: B sütunu (Kod)="${b_str}"`);
                
                // Kod bilgisi B sütununda
                if (b_str === kod_str) {
                    matched = true;
                    console.log(`Eşleşme bulundu: Satır ${row}`);
                    
                    // J sütununda veri varsa kesin tonaj, yoksa K sütunundaki tahmini tonaj
                    const j_cell = sheet[XLSX.utils.encode_cell({c:9, r:row})];
                    const k_cell = sheet[XLSX.utils.encode_cell({c:10, r:row})];
                    const l_cell = sheet[XLSX.utils.encode_cell({c:11, r:row})];
                    
                    // Cell değerleri hakkında daha fazla bilgi
                    console.log(`Bulundu (Satır ${row}):\n` + 
                               `J hücresi (Kesin Tonaj): `, j_cell, '\n' + 
                               `K hücresi (Tahmini Tonaj): `, k_cell, '\n' + 
                               `L hücresi (Tahmini Tenefer): `, l_cell);
                    
                    // Get values with safe defaults
                    const kesin = j_cell?.v;
                    const tahmini = k_cell?.v;
                    const tenefer = l_cell?.v;
                    
                    return callback({
                        kesin: kesin !== undefined ? kesin : '', 
                        tahmini: tahmini !== undefined ? tahmini : '',
                        tenefer: tenefer !== undefined ? tenefer : ''
                    });
                }
            }
            
            if (!matched) {
                console.log(`Eşleşme bulunamadı: Kod='${kod}'`);
            }
            callback({ kesin: '', tahmini: '', tenefer: '' });
        }
    );
}

function fetchSayfa1FigurRows(kod, callback) {
    // SAYFA1 gid: 1238184358
    requestSheetFromProxy(
        'https://docs.google.com/spreadsheets/d/1RP5kRFKAUUJye7-lPnlmeNaN805eF_88/export?format=xlsx&id=1RP5kRFKAUUJye7-lPnlmeNaN805eF_88&gid=1238184358',
        '1238184358',
        function(buffer) {
            const workbook = XLSX.read(buffer, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const range = XLSX.utils.decode_range(sheet['!ref']);
            let rows = [];
            const kodStr = String(kod).trim().toLowerCase();
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const kodCell = sheet[XLSX.utils.encode_cell({c:1, r:row})]; // B sütunu
                if (kodCell && String(kodCell.v).trim().toLowerCase() === kodStr) {
                    rows.push({
                        figur: sheet[XLSX.utils.encode_cell({c:3, r:row})]?.v || '', // D
                        firma: sheet[XLSX.utils.encode_cell({c:4, r:row})]?.v || '', // E
                        kesin_tonaj: sheet[XLSX.utils.encode_cell({c:9, r:row})]?.v || '', // J
                        tahmini_tonaj: sheet[XLSX.utils.encode_cell({c:10, r:row})]?.v || '', // K
                        tahmini_tenefer: sheet[XLSX.utils.encode_cell({c:11, r:row})]?.v || '' // L
                    });
                }
            }
            callback(rows);
        }
    );
}

function showPopup(row, detaySatirlar, kod) {
    const modal = document.getElementById('reportModal');
    const content = document.getElementById('reportContent');
    
    // Raporun oluşturulma tarihini formatla (gg.aa.yyyy)
    const bugun = new Date();
    const gun = String(bugun.getDate()).padStart(2, '0');
    const ay = String(bugun.getMonth() + 1).padStart(2, '0'); // Ay 0-11 aralığında
    const yil = bugun.getFullYear();
    const formatlanmisTarih = `${gun}.${ay}.${yil}`;
    
    content.innerHTML = `<div class="popup-rapor">
        <div class="popup-header">
            <img src='logo.png' class='popup-logo' />
            <div class='popup-title'>BEYMETAL KALIP RAPOR</div>
            <div class='popup-date'>Rapor Tarihi: ${formatlanmisTarih}</div>
            <span class='popup-close' title='Kapat'>&times;</span>
        </div>
        <div class='popup-body'>
            <div class='popup-kod'><b>Profil Kodu:</b> <span>${kod}</span></div>
            <div class='popup-toplam-adet'><b>Toplam Adet:</b> <span>${row['TOPLAM ADET'] || 'Veri yok'}</span></div>
            <div class='popup-grup'><b>Kalıplar:</b><div class='popup-gruplar'></div></div>
            <div class='popup-son-tarih'></div>
            <div class='popup-figur-tonaj'></div>
            <div class='popup-yuzdelik-grafik'></div>
        </div>
        <div class='popup-footer'>
            <button class='pdf-download-btn'><i class='fas fa-file-pdf'></i> PDF olarak indir</button>
            <div class='pdf-auto-text'>Bu rapor otomatik olarak oluşturulmuştur</div>
        </div>
    </div>`;
    modal.style.display = 'flex';
    // Gruplama
    const gruplar = groupByFigurAndFirma(detaySatirlar);
    const gruplarDiv = content.querySelector('.popup-gruplar');
    gruplar.forEach(g => {
        const el = document.createElement('div');
        el.textContent = `${g.figur} ${g.count} ${g.firma}`;
        el.className = 'popup-grup-item';
        el.addEventListener('click', () => {
            fetchSayfa1Tonaj(g.figur, function(tonaj) {
                let val, tip;
                
                // Güncellenmiş tonaj bilgisi gösterimi:
                // 1. Eğer J sütununda (kesin) veri varsa onu göster
                // 2. J sütununda veri yoksa K sütunundaki (tahmini) veriyi göster
                if (tonaj.kesin && tonaj.kesin !== '' && tonaj.kesin !== 0) {
                    val = tonaj.kesin;
                    tip = 'Kesin Tonaj';
                } else if (tonaj.tahmini && tonaj.tahmini !== '' && tonaj.tahmini !== 0) {
                    val = tonaj.tahmini;
                    tip = 'Tahmini Tonaj';
                } else {
                    val = '';
                    tip = '';
                }
                
                content.querySelector('.popup-figur-tonaj').innerHTML = `<b>${g.figur} için ${tip}:</b> <span>${val}</span>`;
                
                // Yüzdelik grafik gösterimi
                let yuzde = 0;
                if (val && !isNaN(val)) yuzde = Math.min(100, Math.round((val/15000)*100));
                content.querySelector('.popup-yuzdelik-grafik').innerHTML = `<div class='progress-bar'><div class='progress-fill' style='width:${yuzde}%;'>${yuzde}%</div></div>`;
            });
        });
        gruplarDiv.appendChild(el);
    });
    if (gruplar.length) gruplarDiv.children[0].click();
    // Figür/Firma/Tonaj/Tenefer tablosu
    fetchSayfa1FigurRows(kod, function(figurSatirlari) {
        if (figurSatirlari && figurSatirlari.length) {
            let yuzdelikBar = '';
            let yuzde = 0;
            let tonajInt = 0;
            let barColor = '#00ff88';
            let tonajTip = '';
            let tonaj = '';
            let tenefer = '';
            figurSatirlari.forEach(r => {
                if (r.kesin_tonaj && r.kesin_tonaj !== '' && r.kesin_tonaj !== 0) {
                    tonaj = r.kesin_tonaj;
                    tonajTip = 'Kesin';
                } else if (r.tahmini_tonaj && r.tahmini_tonaj !== '' && r.tahmini_tonaj !== 0) {
                    tonaj = r.tahmini_tonaj;
                    tonajTip = 'Tahmini';
                } else {
                    tonaj = '';
                    tonajTip = '';
                }
                tonajInt = parseInt(tonaj);
                tenefer = r.tahmini_tenefer || '';
            });
            if (!isNaN(tonajInt) && tonajInt > 0) {
                yuzde = Math.min(100, Math.round((tonajInt / 15000) * 100));
                // 100'e yakınsa kırmızı, düşükse yeşil
                barColor = yuzde >= 95 ? '#ff4d4d' : yuzde >= 80 ? '#ffe400' : '#00ff88';
                yuzdelikBar = `<div class='figur-progress-bar'><div class='figur-progress-fill' style='width:${yuzde}%;background:${barColor};'>${yuzde}%</div></div>`;
            }
            content.querySelector('.popup-figur-tonaj').innerHTML = `<div class='popup-figur-list'><b>Figür/Firma/Tonaj/Tenefer Bilgileri:</b><table class='popup-tablo figur-table'><tr><th>Figür</th><th>Firma</th><th>Tonaj</th><th>Tahmini Tenefer</th></tr>`;
            figurSatirlari.forEach(r => {
                let tonaj = '';
                let tonajTip = '';
                if (r.kesin_tonaj && r.kesin_tonaj !== '' && r.kesin_tonaj !== 0) {
                    tonaj = r.kesin_tonaj;
                    tonajTip = 'Kesin';
                } else if (r.tahmini_tonaj && r.tahmini_tonaj !== '' && r.tahmini_tonaj !== 0) {
                    tonaj = r.tahmini_tonaj;
                    tonajTip = 'Tahmini';
                }
                let tonajInt = parseInt(tonaj);
                content.querySelector('.popup-figur-tonaj').innerHTML += `<tr><td>${r.figur || ''}</td><td>${r.firma || ''}</td><td>${tonajInt ? tonajInt + ' ' + tonajTip : ''}</td><td>${r.tahmini_tenefer || ''}</td></tr>`;
            });
            content.querySelector('.popup-figur-tonaj').innerHTML += '</table>';
            if (yuzdelikBar) {
              content.querySelector('.popup-figur-tonaj').innerHTML += `<div class='figur-bar-bottom'>${yuzdelikBar}</div>`;
            }
        } else {
            content.querySelector('.popup-figur-tonaj').innerHTML = '<b>Figür/Firma/Tonaj/Tenefer Bilgileri:</b> Veri bulunamadı.';
        }
    });
    // Son 4 üretim tablosunu geri getirdim
    fetchSayfa4Son4Tarih(kod, function(sonlar) {
        let tablo = '';
        if (sonlar && sonlar.length) {
            tablo += `<b>Son 4 üretim:</b><table class='popup-tablo a4-table'><tr><th>Tarih</th><th>Sipariş Boyu</th><th>Üretilen Adet</th><th>Üretilen KG</th><th>PRES</th><th>FİRMA</th><th>Sorun</th><th>Tashihat</th></tr>`;
            sonlar.forEach(s => {
                tablo += `<tr><td>${formatDateForPopup(s.tarih)}</td><td>${s.siparis_boyu}</td><td>${s.uretilen_adet}</td><td>${s.uretilen_kg}</td><td>${s.pres || ''}</td><td>${s.firma || ''}</td><td>${s.sorun}</td><td>${s.tashihat}</td></tr>`;
            });
            tablo += '</table>';
        } else {
            tablo += '<b>Son 4 üretim:</b> Veri bulunamadı.';
        }
        content.querySelector('.popup-son-tarih').innerHTML = tablo;
    });
    // X kapatma tuşunu tekrar etkinleştir
    content.querySelector('.popup-close').onclick = function() {
        modal.style.display = 'none';
    };
    // PDF butonu: PDF çıktısı için popup içeriği hazır olduğunda ve tüm dinamik veriler yüklendikten sonra tetiklenmeli
    content.querySelector('.pdf-download-btn').onclick = function() {
        try {
            // PDF için özel bir HTML yapısı oluştur
            let pdfContent = document.createElement('div');
            pdfContent.style.width = '100%';
            pdfContent.style.maxWidth = '100%';
            pdfContent.style.margin = '0 auto';
            pdfContent.style.padding = '20px';
            pdfContent.style.boxSizing = 'border-box';
            pdfContent.style.background = '#fff';
            pdfContent.style.color = '#000';
            pdfContent.style.fontFamily = 'Arial, sans-serif';
            
            // Başlık kısmı
            let header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '20px';
            header.style.width = '100%';
            header.style.textAlign = 'center';
            
            // Logo
            let logo = document.createElement('img');
            logo.src = 'logo.png'; // Proje klasöründeki logo.png dosyası
            logo.style.width = '80px'; // 50px'den 80px'e büyütüyorum
            logo.style.height = 'auto';
            logo.style.marginRight = '10px';
            
            // Başlık
            let title = document.createElement('h1');
            title.textContent = 'BEYMETAL KALIP RAPOR';
            title.style.color = '#0099ff';
            title.style.fontSize = '24px';
            title.style.margin = '0';
            title.style.textAlign = 'center';
            title.style.width = '100%';
            
            // Tarih - null kontrolü ile
            let tarihText = '';
            const tarihElement = document.querySelector('.popup-rapor .popup-tarih');
            if (tarihElement) {
                tarihText = tarihElement.textContent || '';
            } else {
                tarihText = new Date().toLocaleDateString('tr-TR');
            }
            
            let date = document.createElement('div');
            date.textContent = 'Rapor Tarihi: ' + tarihText;
            date.style.fontSize = '14px';
            
            header.appendChild(logo);
            header.appendChild(title);
            header.appendChild(date);
            
            // Profil bilgileri
            let profileInfo = document.createElement('div');
            profileInfo.style.marginBottom = '20px';
            profileInfo.style.width = '100%';
            
            // Profil kodu - null kontrolü ile
            let kodText = '';
            const kodElement = document.querySelector('.popup-rapor .popup-kod');
            if (kodElement) {
                kodText = kodElement.textContent || '';
            }
            
            let profileCode = document.createElement('div');
            profileCode.innerHTML = '<b>Profil Kodu:</b> ' + kodText;
            profileCode.style.marginBottom = '10px';
            profileCode.style.fontSize = '16px';
            
            // Toplam adet - null kontrolü ile
            let adetText = row['TOPLAM ADET'] || 'Veri yok';
            const totalCount = document.createElement('div');
            totalCount.style.marginBottom = '10px';
            totalCount.innerHTML = '<b>Toplam Adet:</b> ' + adetText;
            
            // Kalıplar
            let molds = document.createElement('div');
            molds.innerHTML = '<b>Kalıplar:</b>';
            molds.style.marginBottom = '10px';
            molds.style.fontSize = '16px';
            
            // Kalıp listesini doldur - popup'daki kalıp bilgilerini kullan
            let kaliplarHTML = '';
            const kalipElements = document.querySelectorAll('.popup-rapor .popup-gruplar .popup-grup-item');
            if (kalipElements && kalipElements.length > 0) {
                kalipElements.forEach(kalip => {
                    if (kalip && kalip.textContent) {
                        kaliplarHTML += `<div style="padding:5px;margin-bottom:5px;background-color:#e6fffa;border-radius:5px;">${kalip.textContent}</div>`;
                    }
                });
            } else {
                // Kalıplar bulunamazsa, detay satırlarını kullan
                if (detaySatirlar && detaySatirlar.length > 0) {
                    detaySatirlar.forEach(satir => {
                        kaliplarHTML += `<div style="padding:5px;margin-bottom:5px;background-color:#e6fffa;border-radius:5px;">${satir}</div>`;
                    });
                } else {
                    // Son olarak sonuç satırlarını kullan
                    const resultRows = document.querySelectorAll('.search-results .result-row');
                    if (resultRows && resultRows.length > 0) {
                        resultRows.forEach(row => {
                            if (row && row.textContent) {
                                kaliplarHTML += `<div style="padding:5px;margin-bottom:5px;background-color:#e6fffa;border-radius:5px;">${row.textContent}</div>`;
                            }
                        });
                    }
                }
            }
            
            if (kaliplarHTML === '') {
                kaliplarHTML = 'Kalıp bilgisi bulunamadı.';
            }
            let moldList = document.createElement('div');
            moldList.style.backgroundColor = '#e6fffa';
            moldList.style.padding = '10px';
            moldList.style.borderRadius = '5px';
            moldList.style.marginBottom = '20px';
            moldList.style.fontSize = '16px';
            moldList.style.width = '100%';
            moldList.style.textAlign = 'center';
            moldList.innerHTML = kaliplarHTML;
            
            profileInfo.appendChild(profileCode);
            profileInfo.appendChild(totalCount);
            profileInfo.appendChild(molds);
            profileInfo.appendChild(moldList);
            
            // Son 4 üretim tablosu
            let lastProductionTitle = document.createElement('div');
            lastProductionTitle.innerHTML = '<b>Son 4 üretim:</b>';
            lastProductionTitle.style.marginBottom = '10px';
            lastProductionTitle.style.fontSize = '16px';
            
            // Son 4 üretim tablosunu kopyala - null kontrolü ile
            let son4UretimTable = null;
            const son4UretimElement = document.querySelector('.popup-rapor .popup-son-tarih table');
            if (son4UretimElement) {
                son4UretimTable = son4UretimElement.cloneNode(true);
                son4UretimTable.style.width = '100%';
                son4UretimTable.style.borderCollapse = 'collapse';
                son4UretimTable.style.marginBottom = '20px';
                son4UretimTable.style.fontSize = '14px';
                
                // Tablo hücrelerinin düzenini değiştir
                const cells = son4UretimTable.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.padding = '8px';
                    cell.style.border = '1px solid #ddd';
                    cell.style.textAlign = 'center';
                });
                
                // Başlık hücrelerinin arka plan rengi
                const headers = son4UretimTable.querySelectorAll('th');
                headers.forEach(header => {
                    header.style.backgroundColor = '#e6f7ff';
                    header.style.color = '#0066cc';
                    header.style.fontWeight = 'bold';
                });
            } else {
                son4UretimTable = document.createElement('div');
                son4UretimTable.textContent = 'Son 4 üretim verisi bulunamadı.';
            }
            
            // Figür/Firma/Tonaj/Tenefer tablosu
            let figurTitle = document.createElement('div');
            figurTitle.innerHTML = '<b>Figür/Firma/Tonaj/Tenefer Bilgileri:</b>';
            figurTitle.style.marginBottom = '10px';
            figurTitle.style.fontSize = '16px';
            
            // Figür tablosunu kopyala - null kontrolü ile
            let figurTable = null;
            const figurElement = document.querySelector('.popup-rapor .figur-table');
            if (figurElement) {
                figurTable = figurElement.cloneNode(true);
                figurTable.style.width = '100%';
                figurTable.style.borderCollapse = 'collapse';
                figurTable.style.marginBottom = '10px';
                figurTable.style.fontSize = '14px';
                
                // Tablo hücrelerinin düzenini değiştir
                const cells = figurTable.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.padding = '8px';
                    cell.style.border = '1px solid #ddd';
                    cell.style.textAlign = 'center';
                });
                
                // Başlık hücrelerinin arka plan rengi
                const headers = figurTable.querySelectorAll('th');
                headers.forEach(header => {
                    header.style.backgroundColor = '#e6f7ff';
                    header.style.color = '#0066cc';
                    header.style.fontWeight = 'bold';
                });
                
                // Eger tablo bosssa, verileri manuel olarak ekle
                if (figurTable.querySelectorAll('tr').length <= 1) {
                    // Figür satırlarını al
                    fetchSayfa1FigurRows(kod, function(figurSatirlari) {
                        if (figurSatirlari && figurSatirlari.length > 0) {
                            figurSatirlari.forEach(r => {
                                const row = document.createElement('tr');
                                
                                const figur = document.createElement('td');
                                figur.textContent = r.figur || '';
                                row.appendChild(figur);
                                
                                const firma = document.createElement('td');
                                firma.textContent = r.firma || '';
                                row.appendChild(firma);
                                
                                const tonaj = document.createElement('td');
                                let tonajText = '';
                                if (r.kesin_tonaj && r.kesin_tonaj !== '' && r.kesin_tonaj !== 0) {
                                    tonajText = r.kesin_tonaj + ' Kesin';
                                } else if (r.tahmini_tonaj && r.tahmini_tonaj !== '' && r.tahmini_tonaj !== 0) {
                                    tonajText = r.tahmini_tonaj + ' Tahmini';
                                }
                                tonaj.textContent = tonajText;
                                row.appendChild(tonaj);
                                
                                const tenefer = document.createElement('td');
                                tenefer.textContent = r.tahmini_tenefer || '';
                                row.appendChild(tenefer);
                                
                                figurTable.appendChild(row);
                            });
                        }
                    });
                }
            } else {
                figurTable = document.createElement('div');
                figurTable.textContent = 'Figür/Firma/Tonaj/Tenefer verisi bulunamadı.';
            }
            
            // Yüzdelik bar
            let percentageBar = document.createElement('div');
            percentageBar.style.width = '100%';
            percentageBar.style.height = '20px';
            percentageBar.style.backgroundColor = '#eaf9fc';
            percentageBar.style.borderRadius = '10px';
            percentageBar.style.overflow = 'hidden';
            percentageBar.style.marginBottom = '20px';
            
            let percentageFill = document.createElement('div');
            let yuzde = '0%';
            let yuzdeElement = document.querySelector('.popup-rapor .figur-progress-fill');
            if (yuzdeElement) {
                yuzde = yuzdeElement.textContent || '0%';
            }
            
            let yuzdeValue = parseInt(yuzde);
            let barColor = yuzdeValue >= 95 ? '#ff4d4d' : yuzdeValue >= 80 ? '#ffe400' : '#00ff88';
            
            percentageFill.style.width = yuzde;
            percentageFill.style.height = '100%';
            percentageFill.style.backgroundColor = barColor;
            percentageFill.style.textAlign = 'center';
            percentageFill.style.color = '#222';
            percentageFill.style.lineHeight = '20px';
            percentageFill.style.fontWeight = 'bold';
            percentageFill.textContent = yuzde;
            
            percentageBar.appendChild(percentageFill);
            
            // PDF içeriğini birleştir
            pdfContent.appendChild(header);
            pdfContent.appendChild(profileInfo);
            pdfContent.appendChild(lastProductionTitle);
            pdfContent.appendChild(son4UretimTable);
            pdfContent.appendChild(figurTitle);
            pdfContent.appendChild(figurTable);
            pdfContent.appendChild(percentageBar);
            
            // PDF oluştur
            const opt = {
                margin: [10, 10, 10, 10],
                filename: 'beymetal_kalip_rapor.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 2, backgroundColor: '#fff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(pdfContent).save();
        } catch (error) {
            console.error('PDF oluşturma hatası:', error);
            alert('PDF oluşturulurken bir hata oluştu. Lütfen tekrar deneyin.');
        }
    });
}

function showResults(results) {
    const container = document.getElementById('results');
    if (!results.length) {
        container.innerHTML = '<div class="no-result">Sonuç bulunamadı.</div>';
        return;
    }
    let html = '';
    results.forEach((row, idx) => {
        let detaySatirlar = [];
        const figurler = ['1 FİGÜR', '2 FİGÜR', '3 FİGÜR', '4 FİGÜR', '6 FİGÜR'];
        figurler.forEach(figur => {
            if (row[figur]) {
                const parcalar = String(row[figur]).split(/\s+/).filter(Boolean);
                for (let i = 0; i < parcalar.length; i += 2) {
                    let adet = parseInt(parcalar[i]);
                    let firma = parcalar[i+1] ? parcalar[i+1].toUpperCase() : '';
                    if (!isNaN(adet) && firma) {
                        for (let j = 0; j < adet; j++) {
                            detaySatirlar.push(figur + ' ' + firma);
                        }
                    } else if (parcalar[i] && !isNaN(Number(parcalar[i])) === false) {
                        detaySatirlar.push(figur + ' ' + parcalar[i].toUpperCase());
                    }
                }
            }
        });
        html += `<div class="result-box animated" tabindex="0" style="cursor:pointer;overflow-x:auto;">
            <div class="profil-header"><b>PROFİL KODU:</b> ${row['PROFİL KODU']} <span class="adet-badge">${row['TOPLAM ADET'] || 'Veri yok'}</span></div>
            <div class="detay-list">
                ${detaySatirlar.map(satir => `<div class="detay-item">${satir}</div>`).join('')}
            </div>
        </div>`;
    });
    container.innerHTML = html;
    setTimeout(() => {
        document.querySelectorAll('.result-box.animated').forEach((el, i) => {
            el.classList.add('fade-in');
            el.style.transitionDelay = (i * 0.07) + 's';
        });
        // Tıklanabilirlik ve popup
        document.querySelectorAll('.result-box').forEach((el, i) => {
            el.onclick = () => {
                const row = results[i];
                let detaySatirlar = [];
                const figurler = ['1 FİGÜR', '2 FİGÜR', '3 FİGÜR', '4 FİGÜR', '6 FİGÜR'];
                figurler.forEach(figur => {
                    if (row[figur]) {
                        const parcalar = String(row[figur]).split(/\s+/).filter(Boolean);
                        for (let j = 0; j < parcalar.length; j += 2) {
                            let adet = parseInt(parcalar[j]);
                            let firma = parcalar[j+1] ? parcalar[j+1].toUpperCase() : '';
                            if (!isNaN(adet) && firma) {
                                for (let k = 0; k < adet; k++) {
                                    detaySatirlar.push(figur + ' ' + firma);
                                }
                            } else if (parcalar[j] && !isNaN(Number(parcalar[j])) === false) {
                                detaySatirlar.push(figur + ' ' + parcalar[j].toUpperCase());
                            }
                        }
                    }
                });
                showPopup(row, detaySatirlar, row['PROFİL KODU']);
            };
        });
    }, 50);
}

// --- YÜKLENİYOR ANİMASYONU ve GÜNCELLEME BİLDİRİMİ ---
function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = show ? 'flex' : 'none';
}
function showUpdateNotification() {
    const notif = document.getElementById('updateNotification');
    if (!notif) return;
    notif.classList.add('show');
    notif.style.display = 'block';
    setTimeout(() => {
        notif.classList.remove('show');
        notif.style.display = 'none';
    }, 2000);
}

// --- STAT-BOX ANİMASYON SIRALAMASI ---
function animateStatBoxes() {
    const boxes = document.querySelectorAll('.stat-box');
    boxes.forEach((box, i) => {
        box.style.animationDelay = (i * 0.18 + 0.35) + 's';
        box.tabIndex = 0;
    });
}

let lastOzetHash = null;

document.addEventListener('DOMContentLoaded', () => {
    waitProxyReady(() => {
        fetchAndAnimateStats();
        animateStatBoxes();
    });
    initLogoAnim();
    initTitleAnim();
    // Arama butonu ve enter event
    document.getElementById('searchButton').addEventListener('click', () => {
        showLoading(true);
        const kod = document.getElementById('kalipKodu').value;
        searchProfileCode(kod);
        setTimeout(()=>showLoading(false), 1000);
    });
    document.getElementById('kalipKodu').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            showLoading(true);
            const kod = document.getElementById('kalipKodu').value;
            searchProfileCode(kod);
            setTimeout(()=>showLoading(false), 1000);
        }
    });
});
